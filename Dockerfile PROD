FROM ghcr.io/fintronners/base-go:latest AS builder

WORKDIR /app

# Copy go.mod and go.sum FIRST (for better caching)
COPY go.mod go.sum ./

# Download dependencies (this layer will be cached)
RUN go mod tidy

# NOW copy the source code
COPY . .

# Build with optimized settings
RUN GOOS=linux GOARCH=amd64 GOMEMLIMIT=12GiB GOMAXPROCS=4 \
    go build --tags=PROD -o build/ftron/ftron cmd/ftron/main.go

FROM --platform=linux/amd64 alpine:3

WORKDIR /app

RUN apk update && apk add --no-cache tzdata

COPY --from=builder /app/build/ftron/ftron .

CMD ["./ftron"]
